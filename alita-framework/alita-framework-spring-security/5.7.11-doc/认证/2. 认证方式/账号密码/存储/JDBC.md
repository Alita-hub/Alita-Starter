# JDBC Authentication

Spring Security 的 `JdbcDaoImpl` 实现了 `UserDetailsService`，为使用 JDBC 获取的基于用户名/密码的身份验证提供支持。
`JdbcUserDetailsManager` 扩展了 `JdbcDaoImpl`，通过 `UserDetailsManager` 接口提供对 `UserDetails` 的管理。
当 Spring Security 被配置为接受用户名/密码进行身份验证时，它就会使用基于 `UserDetails` 的身份验证。

下面我们将讨论:
- Spring Security JDBC 身份验证使用的默认模式
- 设置数据源
- JdbcUserDetailsManager Bean

# Default Schema

Spring Security 为基于 JDBC 的身份验证提供了默认查询。本节提供了默认查询使用的相应默认模式。
您需要调整模式，以匹配对查询和所使用数据库方言的任何自定义。

# User Schema

`JdbcDaoImpl` 需要一些表来加载用户的密码、账户状态（启用或禁用）和权限（角色）列表。所需的默认模式如下。

```sql
create table users(
	username varchar_ignorecase(50) not null primary key,
	password varchar_ignorecase(500) not null,
	enabled boolean not null
);

create table authorities (
	username varchar_ignorecase(50) not null,
	authority varchar_ignorecase(50) not null,
	constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username,authority);
```

Oracle 是一种常用的数据库选择，但所需的模式略有不同。用户可在下面找到默认的 Oracle 模式。

Oracle 数据库的默认用户模式
```sql
CREATE TABLE USERS (
    USERNAME NVARCHAR2(128) PRIMARY KEY,
    PASSWORD NVARCHAR2(128) NOT NULL,
    ENABLED CHAR(1) CHECK (ENABLED IN ('Y','N') ) NOT NULL
);


CREATE TABLE AUTHORITIES (
    USERNAME NVARCHAR2(128) NOT NULL,
    AUTHORITY NVARCHAR2(128) NOT NULL
);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_UNIQUE UNIQUE (USERNAME, AUTHORITY);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_FK1 FOREIGN KEY (USERNAME) REFERENCES USERS (USERNAME) ENABLE;
```

# Group Schema

如果您的应用程序使用组，则需要提供组模式。组的默认模式如下。

默认组模式
```sql
create table groups (
	id bigint generated by default as identity(start with 0) primary key,
	group_name varchar_ignorecase(50) not null
);

create table group_authorities (
	group_id bigint not null,
	authority varchar(50) not null,
	constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
	id bigint generated by default as identity(start with 0) primary key,
	username varchar(50) not null,
	group_id bigint not null,
	constraint fk_group_members_group foreign key(group_id) references groups(id)
);
```

# Setting up a DataSource

在配置 `JdbcUserDetailsManager` 之前，我们必须创建一个数据源。在我们的示例中，我们将设置一个嵌入式数据源，并使用默认用户模式进行初始化。

```java
@Bean
DataSource dataSource() {
	return new EmbeddedDatabaseBuilder()
		.setType(H2)
		.addScript(JdbcDaoImpl.DEFAULT_USER_SCHEMA_DDL_LOCATION)
		.build();
}
```

# JdbcUserDetailsManager Bean

在本示例中，我们使用 Spring Boot CLI 对 password 的密码进行编码，得到的编码密码为 {bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW。
有关如何存储密码的更多详情，请参阅密码编码器部分。

```java
@Bean
UserDetailsManager users(DataSource dataSource) {
	UserDetails user = User.builder()
		.username("user")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER")
		.build();
	UserDetails admin = User.builder()
		.username("admin")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER", "ADMIN")
		.build();
	JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
	users.createUser(user);
	users.createUser(admin);
	return users;
}
```


